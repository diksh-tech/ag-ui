# ag_ui_server.py
import os
import uuid
import json
from typing import AsyncGenerator, Dict, Any
from fastapi import FastAPI, Request, HTTPException
from fastapi.responses import StreamingResponse
from fastapi.middleware.cors import CORSMiddleware
from openai import AzureOpenAI
from dotenv import load_dotenv

load_dotenv()

app = FastAPI(title="FlightOps AG-UI Server")

# Add CORS middleware
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_methods=["*"],
    allow_headers=["*"],
)

# Azure OpenAI client
client = AzureOpenAI(
    api_key=os.getenv("AZURE_OPENAI_KEY"),
    api_version=os.getenv("AZURE_API_VERSION", "2024-12-01-preview"),
    azure_endpoint=os.getenv("AZURE_OPENAI_ENDPOINT")
)

@app.post("/agent")
async def flight_agent_endpoint(request: Request):
    """AG-UI compatible flight operations agent"""
    
    try:
        # Parse the request body
        body = await request.json()
        print(f"üì• Received request: {json.dumps(body, indent=2)}")
        
        # Extract messages from the request
        messages = body.get("messages", [])
        thread_id = body.get("thread_id", "default-thread")
        run_id = body.get("run_id", f"run-{uuid.uuid4().hex[:8]}")
        
        if not messages:
            raise HTTPException(status_code=400, detail="No messages provided")
            
        # Get the latest user message
        user_message = None
        for msg in reversed(messages):
            if msg.get("role") == "user":
                user_message = msg.get("content", "")
                break
        
        if not user_message:
            raise HTTPException(status_code=400, detail="No user message found")

        async def event_generator() -> AsyncGenerator[str, None]:
            try:
                # Emit RUN_STARTED
                yield f"data: {json.dumps({'type': 'RUN_STARTED', 'thread_id': thread_id, 'run_id': run_id})}\n\n"
                
                # Emit TEXT_MESSAGE_START
                message_id = f"msg-{uuid.uuid4().hex[:8]}"
                yield f"data: {json.dumps({'type': 'TEXT_MESSAGE_START', 'message_id': message_id, 'role': 'assistant'})}\n\n"

                # Call Azure OpenAI (non-streaming for simplicity)
                completion = client.chat.completions.create(
                    model=os.getenv("AZURE_OPENAI_DEPLOYMENT", "gpt-4o"),
                    messages=[
                        {"role": "system", "content": "You are a helpful flight operations assistant."},
                        {"role": "user", "content": user_message}
                    ],
                    max_tokens=500
                )

                response_text = completion.choices[0].message.content
                
                # Stream response in chunks to simulate real streaming
                words = response_text.split()
                for i, word in enumerate(words):
                    yield f"data: {json.dumps({'type': 'TEXT_MESSAGE_CONTENT', 'message_id': message_id, 'delta': word + ' '})}\n\n"
                    # Small delay to simulate streaming
                    # await asyncio.sleep(0.05)

                # Emit TEXT_MESSAGE_END
                yield f"data: {json.dumps({'type': 'TEXT_MESSAGE_END', 'message_id': message_id})}\n\n"
                
                # Emit RUN_FINISHED
                yield f"data: {json.dumps({'type': 'RUN_FINISHED', 'thread_id': thread_id, 'run_id': run_id})}\n\n"

            except Exception as error:
                print(f"‚ùå Error in event generator: {error}")
                yield f"data: {json.dumps({'type': 'RUN_ERROR', 'message': str(error)})}\n\n"

        return StreamingResponse(
            event_generator(),
            media_type="text/event-stream",
            headers={
                "Cache-Control": "no-cache",
                "Connection": "keep-alive",
            }
        )

    except Exception as e:
        print(f"‚ùå Server error: {e}")
        raise HTTPException(status_code=500, detail=str(e))

@app.get("/")
async def health_check():
    return {"status": "healthy", "service": "FlightOps AG-UI Server"}

if __name__ == "__main__":
    import uvicorn
    uvicorn.run(app, host="0.0.0.0", port=8001, reload=True)
###############################################################################
# ag_ui_client.py
import asyncio
import httpx
import json
from datetime import datetime

async def call_ag_ui_agent():
    url = "http://localhost:8001/agent"
    
    # Correct AG-UI request format
    input_data = {
        "thread_id": "main-thread",
        "run_id": f"run-{int(datetime.now().timestamp())}",
        "messages": [
            {
                "id": "msg-1",
                "role": "user", 
                "content": "What's the status of flight 6E 215 on 2024-06-23?"
            }
        ],
        "tools": []
    }
    
    print("üîÑ Connecting to AG-UI server...")
    print(f"üì§ Sending request: {json.dumps(input_data, indent=2)}")
    
    async with httpx.AsyncClient(timeout=30.0) as client:
        try:
            async with client.stream(
                "POST",
                url,
                json=input_data,
                headers={
                    "Accept": "text/event-stream",
                    "Content-Type": "application/json"
                }
            ) as response:
                print(f"‚úÖ Connected. Status: {response.status_code}")
                
                if response.status_code != 200:
                    error_body = await response.aread()
                    print(f"‚ùå Server error {response.status_code}: {error_body}")
                    return
                
                print("üéØ Starting to receive events...")
                async for line in response.aiter_lines():
                    line = line.strip()
                    if line.startswith("data: "):
                        event_json = line[6:]  # Remove "data: " prefix
                        if event_json:
                            try:
                                event = json.loads(event_json)
                                event_type = event.get('type', 'UNKNOWN')
                                
                                if event_type == 'TEXT_MESSAGE_CONTENT':
                                    # Print streaming text
                                    print(event.get('delta', ''), end='', flush=True)
                                elif event_type == 'RUN_STARTED':
                                    print(f"\nüöÄ Agent started...")
                                elif event_type == 'TEXT_MESSAGE_START':
                                    print(f"\nüí¨ Assistant: ", end='', flush=True)
                                elif event_type == 'TEXT_MESSAGE_END':
                                    print("\n")  # New line after message
                                elif event_type == 'RUN_FINISHED':
                                    print(f"‚úÖ Agent finished successfully!")
                                elif event_type == 'RUN_ERROR':
                                    print(f"\n‚ùå Error: {event.get('message', 'Unknown error')}")
                                else:
                                    print(f"\nüîπ [{event_type}]")
                                    
                            except json.JSONDecodeError as e:
                                print(f"\n‚ö†Ô∏è Could not parse event: {event_json}")
                                print(f"Error: {e}")
                                
        except httpx.ConnectError:
            print("‚ùå Could not connect to server. Make sure ag_ui_server.py is running on port 8001.")
        except Exception as e:
            print(f"‚ùå Unexpected error: {e}")

if __name__ == "__main__":
    asyncio.run(call_ag_ui_agent())
